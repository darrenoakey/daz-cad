#!/usr/bin/env python3
"""Smoketest: connect to localhost:8765 and wait for OpenCascade.js to load."""

import sys
import argparse
from playwright.sync_api import sync_playwright


def main():
    parser = argparse.ArgumentParser(description="Smoketest daz-cad server")
    parser.add_argument("--port", type=int, default=8765, help="Server port (default: 8765)")
    parser.add_argument("--timeout", type=int, default=90, help="Max wait seconds (default: 90)")
    args = parser.parse_args()

    url = f"http://localhost:{args.port}/"
    print(f"Connecting to {url} ...")

    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()
        try:
            page.goto(url, wait_until="domcontentloaded", timeout=10000)
        except Exception as e:
            print(f"FAIL: could not connect to {url} â€” {e}")
            browser.close()
            sys.exit(1)

        print("Page loaded, waiting for OpenCascade.js ...")
        try:
            page.wait_for_function(
                """() => {
                    const statusText = document.getElementById('status-text');
                    return statusText && statusText.textContent === 'Ready' && window.Workplane;
                }""",
                timeout=args.timeout * 1000,
            )
        except Exception as e:
            status = page.evaluate(
                "document.getElementById('status-text')?.textContent || 'element not found'"
            )
            print(f"FAIL: OpenCascade.js did not load within {args.timeout}s (status: {status})")
            browser.close()
            sys.exit(1)

        print("OK: OpenCascade.js loaded, Workplane ready.")
        browser.close()


if __name__ == "__main__":
    main()
